package state;

import java.awt.BorderLayout;
import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.MouseEvent;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.RandomAccessFile;

import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;

import controller.state.ChooseVrstaPretrage;
import controller.state.ChooseVrstaPretrage2;
import main.Main;
import main.MainFrame;
import main.ToolBarIznadTabele;

public class SearchState extends State {

	@Override
	public void selectedField() {
		// TODO Auto-generated method stub
		
	}

	@Override
	public void pressButton(ActionEvent e) {
		if(MainFrame.getInstance().getTrenutniEntitet().getEntPaket().toString().equals("Serijski")) {
			int block = MainFrame.getInstance().getTrenutniEntitet().getBlockSize();									
			int atributi = MainFrame.getInstance().getTrenutniEntitet().getChildCount();
			int fileP = 0;
			Object[][] podaci = new Object[block][atributi];
			Object[] heder = new Object[atributi];
			boolean nadjen = false;
			int zaBrisanje = -1;
			for (int i = 0; i < MainFrame.getInstance().getGornjiTabovi().getTabCount(); i++) {
				if (MainFrame.getInstance().getGornjiTabovi().getTitleAt(i)
						.equals(MainFrame.getInstance().getTrenutniEntitet().getEntPaket().getNaziv() + ":"
								+ MainFrame.getInstance().getTrenutniEntitet().getName())) {
					zaBrisanje = i;
					break;
				}
			}
			try {
				RandomAccessFile afile = new RandomAccessFile(MainFrame.getInstance().getTrenutniEntitet().getPath(), "r");
				afile.seek(0);
				int duzinaReda = afile.readLine().length();
				afile.seek(0);
				int brReda = 0;
				int cnt = 0;
				boolean upisano = false;
				MainFrame.getInstance().getTrenutniEntitet().setSeek(0);
				while(afile.getFilePointer() != afile.length() && !nadjen) {
					while(cnt < block) {
						if (MainFrame.getInstance().getTrenutniEntitet().getSeek() > afile.length())
							afile.seek(0);
						String red = afile.readLine();
						int pocetak = 0;
						for (int j = 0; j < atributi; j++) {
							int kraj = pocetak + MainFrame.getInstance().getTrenutniEntitet().getAtributi().get(j).getDuzina();
							if (red.charAt(red.length() - 1) == '0') {
								upisano = true;
								if (kraj < red.length())
									podaci[cnt][j] = red.substring(pocetak, kraj);
								else
									podaci[cnt][j] = red.substring(pocetak, red.length());
							}
							heder[j] = MainFrame.getInstance().getTrenutniEntitet().getAtributi().get(j).getName();
							pocetak = kraj;
						}
						if(upisano)
							cnt++;
						upisano = false;
					}
					cnt = 0;
					for(int i = 0; i < block; i++) {
						if(nadjen) {
							break;
						}
						nadjen = true;
						brReda = i;
						for(int j = 0; j < atributi; j++) {
							String txt = MainFrame.getInstance().getLista().get(j).getText().trim();
							if(!txt.equals("")) {
								String str = (String)podaci[i][j];
								if(!txt.equals(str.trim())) {
									nadjen = false;
	//								brReda = i;
									break;
								}
							}
						}
					}
				}
				MainFrame.getInstance().getTrenutniEntitet().setSeek(afile.getFilePointer());
				JPanel panel = new JPanel();
				BorderLayout bl = new BorderLayout();
				panel.setLayout(bl);
				JTable tabela = new JTable(podaci, heder);
				MainFrame.getInstance().setTrenutnaTabela(tabela);
				JScrollPane scroll = new JScrollPane(tabela);
				ToolBarIznadTabele toolbar = new ToolBarIznadTabele();
				Dimension screenSize = MainFrame.getInstance().getGornji().getSize();
				scroll.setPreferredSize(screenSize);
				scroll.setMaximumSize(screenSize);
				scroll.setMinimumSize(screenSize);
				tabela.setFillsViewportHeight(true);
				panel.add(toolbar, BorderLayout.NORTH);
				panel.add(scroll);
				MainFrame.getInstance().getGornjiTabovi().removeChangeListener(MainFrame.getInstance().getOr());
				MainFrame.getInstance().getGornjiTabovi().remove(zaBrisanje);
				MainFrame.getInstance().getGornjiTabovi().addChangeListener(MainFrame.getInstance().getOr());
				MainFrame.getInstance().getGornjiTabovi().addTab(MainFrame.getInstance().getTrenutniEntitet().getEntPaket().getNaziv() + ":"
						+ MainFrame.getInstance().getTrenutniEntitet().getName(),
						panel);
				MainFrame.getInstance().getGornjiTabovi()
						.setSelectedIndex(MainFrame.getInstance().getGornjiTabovi().getTabCount() - 1);
				MainFrame.getInstance().getTrenutnaTabela().setRowSelectionInterval(brReda, brReda);
			} catch (FileNotFoundException e1) {
				e1.printStackTrace();
			} catch (IOException e1) {
				e1.printStackTrace();
			}
		} else if(MainFrame.getInstance().getTrenutniEntitet().getEntPaket().toString().equals("Sekvencijalni")) {
			ChooseVrstaPretrage2 cvp = new ChooseVrstaPretrage2();
		}
	}
}
